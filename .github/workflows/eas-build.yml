on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v3

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # Bump versionCode in app.json
      - name: ğŸ”„ Bump versionCode in app.json
        run: |
          node -e "
          const fs = require('fs');
          const appJson = require('./app.json');

          // Increment the versionCode
          appJson.expo.android.versionCode += 1;

          fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
          "

      # Bump versionCode in build.gradle
      - name: ğŸ”„ Bump versionCode in build.gradle
        run: |
          sed -i -E 's/versionCode ([0-9]+)/versionCode $((\1 + 1))/e' ./android/app/build.gradle

      # Commit and push changes
      - name: ğŸš€ Commit and Push versionCode updates
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add app.json android/app/build.gradle
          git commit -m "chore: bump versionCode in app.json and build.gradle"
          git push https://PAT_TOKEN@github.com/almustarik/rn-deliveroo-clone.git main
